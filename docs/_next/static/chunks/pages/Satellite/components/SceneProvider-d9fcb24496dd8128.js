(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[536],{1397:function(e,r,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Satellite/components/SceneProvider",function(){return t(9363)}])},9363:function(e,r,t){"use strict";t.r(r),t.d(r,{SceneContext:function(){return s},SceneProvider:function(){return u}});var n=t(2676),o=t(5271),c=t(1521),i=t(8957),l=t(7577);let s=(0,o.createContext)({scene:null,camera:null,renderer:null,controls:null,isInitialized:!1,isRotating:!1,setIsRotating:()=>{},resourceManager:null,getEntityRegistry:()=>null,isLoaded:!1,setIsLoaded:()=>{}}),u=e=>{let{children:r,containerRef:t}=e,[u,a]=(0,o.useState)(!1),[d,p]=(0,o.useState)(!0),[g,h]=(0,o.useState)(!1),[m,v]=(0,o.useState)(null),S=(0,o.useRef)(null),f=(0,o.useRef)(null),P=(0,o.useRef)(null),w=(0,o.useRef)(null),x=(0,o.useRef)(null),M=(0,o.useRef)(new Map),y=(0,o.useRef)([]),R=(0,o.useRef)(1),E=(0,o.useRef)({entities:new Map,register(e){if(this.entities.has(e.id)){console.warn("SceneProvider: 实体ID冲突，已存在ID为 ".concat(e.id," 的实体，将被替换"));let r=this.entities.get(e.id);r&&r.object.parent&&(r.object.parent.remove(r.object),r.dispose())}this.entities.set(e.id,e),console.log("SceneProvider: 注册实体 [".concat(e.type,"] ID: ").concat(e.id))},get(e){return this.entities.get(e)},getByType(e){let r=[];return this.entities.forEach(t=>{t.type===e&&r.push(t)}),r},remove(e){let r=this.entities.get(e);r&&(r.object.parent&&r.object.parent.remove(r.object),r.dispose(),this.entities.delete(e),console.log("SceneProvider: 移除实体 ID: ".concat(e)))},has(e){return this.entities.has(e)},clear(){Array.from(this.entities.keys()).forEach(e=>this.remove(e)),console.log("SceneProvider: 清空所有实体")}}),b=(0,o.useRef)(null),j=(0,o.useCallback)(()=>{if(!t.current||!P.current||!f.current)return;let e=t.current.clientWidth,r=t.current.clientHeight,n=Math.max(e-380,1);f.current.aspect=n/r,f.current.updateProjectionMatrix(),P.current.setSize(e,r),P.current.setViewport(380,0,n,r)},[t]);(0,o.useEffect)(()=>{try{if(!t.current){console.log("SceneProvider: 容器元素不可用，等待DOM加载");return}let e=document.createElement("canvas");if(!(e.getContext("webgl")||e.getContext("experimental-webgl"))){let e="WebGL不受支持，无法初始化3D场景";console.error(e),v(e);return}let r=new c.xsS;r.background=new c.Ilk(0),S.current=r;let n=t.current.clientWidth,o=t.current.clientHeight,s=Math.max(n-380,1),u=new c.cPb(40,s/o,.1,2e3);f.current=u;let d=new i.CP7({antialias:!0,powerPreference:"high-performance",stencil:!1,depth:!0,alpha:!1});d.setSize(n,o),d.setPixelRatio(Math.min(window.devicePixelRatio,2)),d.setViewport(380,0,s,o),d.shadowMap.enabled=!0,d.shadowMap.type=c.ntZ,d.outputColorSpace=c.KI_,d.toneMapping=c.uL9,d.toneMappingExposure=1,d.info.autoReset=!1,t.current.appendChild(d.domElement),P.current=d,console.log("SceneProvider: 渲染器设置完成",{shadowMapEnabled:d.shadowMap.enabled,outputColorSpace:d.outputColorSpace,toneMapping:d.toneMapping,toneMappingExposure:d.toneMappingExposure,pixelRatio:d.getPixelRatio()});let p=new l.z(u,d.domElement);p.enableDamping=!0,p.dampingFactor=.05,p.minDistance=3,p.maxDistance=8,p.enablePan=!1,p.rotateSpeed=.5,p.zoomSpeed=.5,w.current=p;let g=new c.dpR;b.current={textureLoader:g,loadTexture:e=>new Promise((r,t)=>{let n=0,o=()=>{g.load(e,t=>{P.current&&(t.anisotropy=Math.min(4,P.current.capabilities.getMaxAnisotropy())),(e.includes("Albedo")||e.includes("night_lights"))&&(t.colorSpace=c.KI_),t.generateMipmaps=!0,t.minFilter=c.D1R,t.magFilter=c.wem,r(t)},r=>{console.log("SceneProvider: 纹理加载进度: ".concat(e," - ").concat(r.loaded,"/").concat(r.total))},r=>{console.error("SceneProvider: 纹理加载失败: ".concat(e),r),n<3?(n++,console.log("SceneProvider: 重试加载纹理 ".concat(e," (").concat(n,"/").concat(3,")")),setTimeout(o,1e3*n)):t(r)})};o()}),registerUpdateFunction:e=>{let r=R.current++;return M.current.set(r,e),console.log("SceneProvider: 已注册更新函数 ID: ".concat(r)),r},unregisterUpdateFunction:e=>{M.current.delete(e),console.log("SceneProvider: 已注销更新函数 ID: ".concat(e))},registerForCleanup:e=>{y.current.push(e),console.log("SceneProvider: 已注册清理函数")},entityRegistry:E.current},window.addEventListener("resize",j);let h=0,m=0,C=0,_=e=>{if(x.current=requestAnimationFrame(_),!(e-h<16.666666666666668)){if(h=e,m++,e-C>=1e3){let r=Math.round(1e3*m/(e-C));r<30&&console.warn("SceneProvider: 低帧率警告 - ".concat(r," FPS")),m=0,C=e}w.current&&w.current.update(),M.current.forEach(r=>{try{r(e)}catch(e){console.error("SceneProvider: 更新函数执行错误",e)}}),P.current&&S.current&&f.current&&P.current.render(S.current,f.current)}};_(0),a(!0),v(null),console.log("SceneProvider: Three.js环境初始化完成")}catch(r){let e=r instanceof Error?r.message:"初始化失败";console.error("SceneProvider: 初始化错误",r),v(e)}return()=>{if(console.log("SceneProvider: 开始清理Three.js资源"),window.removeEventListener("resize",j),x.current&&(cancelAnimationFrame(x.current),x.current=null,console.log("SceneProvider: 动画帧已取消")),b.current&&b.current.entityRegistry&&(console.log("SceneProvider: 清理所有注册的实体"),b.current.entityRegistry.clear()),console.log("SceneProvider: 执行 ".concat(y.current.length," 个注册的清理函数")),y.current.forEach(e=>{try{e()}catch(e){console.error("执行清理函数时出错:",e)}}),M.current.clear(),y.current=[],P.current){try{t.current&&t.current.contains(P.current.domElement)&&(t.current.removeChild(P.current.domElement),console.log("SceneProvider: 渲染器DOM元素已移除"))}catch(e){console.error("移除渲染器DOM元素时出错:",e)}P.current.dispose(),P.current.forceContextLoss(),P.current=null,console.log("SceneProvider: 渲染器已释放")}w.current&&(w.current.dispose(),w.current=null,console.log("SceneProvider: 控制器已释放")),S.current=null,f.current=null,b.current=null,console.log("SceneProvider: Three.js资源清理完成")}},[t]);let C=(0,o.useMemo)(()=>({scene:S.current,camera:f.current,renderer:P.current,controls:w.current,isInitialized:u,resourceManager:b.current,isRotating:d,setIsRotating:p,getEntityRegistry:()=>{var e;return(null===(e=b.current)||void 0===e?void 0:e.entityRegistry)||null},isLoaded:g,setIsLoaded:h}),[u,d,g]);return m?(0,n.jsx)("div",{className:"error-container",children:(0,n.jsxs)("div",{className:"error-message",children:[(0,n.jsx)("h3",{children:"初始化失败"}),(0,n.jsx)("p",{children:m}),(0,n.jsx)("button",{onClick:()=>window.location.reload(),children:"重新加载"})]})}):(0,n.jsx)(s.Provider,{value:C,children:r})};r.default=u}},function(e){e.O(0,[593,944,577,774,888,179],function(){return e(e.s=1397)}),_N_E=e.O()}]);
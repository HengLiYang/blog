(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[105],{4882:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Satellite/components/Satellite",function(){return r(5814)}])},5814:function(e,t,r){"use strict";r.r(t);var n=r(5271),o=r(1521),i=r(9768),l=r(9363);t.default=e=>{let{satellites:t,onSatelliteClick:r}=e,{scene:s,resourceManager:c,isInitialized:a}=(0,n.useContext)(l.SceneContext),u=(0,n.useRef)({meshes:[],satelliteIds:[],selectedIndex:null,highlightMeshes:new Map});return(0,n.useEffect)(()=>{if(!s||!c||!a||0===t.length){console.log("Satellite: 条件不满足，跳过加载",{scene:!!s,resourceManager:!!c,isInitialized:a,satellitesLength:t.length});return}console.log("Satellite: 开始加载卫星模型",{satellitesCount:t.length,satellites:t.map(e=>({id:e.id,name:e.name,position:e.position,model:e.model}))}),u.current.meshes.length>0&&(u.current.meshes.forEach(e=>{s.remove(e),e.traverse(e=>{e instanceof o.Kj0&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))})}),u.current.highlightMeshes.forEach(e=>{s.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}));let e=[],n=t.map(e=>e.id);return t.forEach(t=>{let[n,l,c]=t.position;try{console.log("Satellite: 开始加载模型",t.model),new i.E().load(t.model,i=>{console.log("卫星加载成功:",t.id,t.model,{scene:i.scene,animations:i.animations,asset:i.asset,sceneChildren:i.scene.children.length});let a=i.scene;a.position.set(n,l,c);let u=1;switch(t.id){case"satellite-1":case"satellite-3":u=3;break;case"satellite-2":u=1;break;case"satellite-4":u=2.5;break;case"satellite-5":u=3.5;break;default:u=2}a.scale.set(u,u,u),a.name="satellite-".concat(t.id);let d=new o.ZzF().setFromObject(a);console.log("Satellite: 模型包围盒信息",JSON.stringify({satelliteId:t.id,scale:u,min:d.min,max:d.max,size:d.getSize(new o.Pa4),center:d.getCenter(new o.Pa4)})),a.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r},a.traverse(e=>{e instanceof o.Kj0&&(e.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r})});let h=new o.Ox3(16777215,1);h.position.set(5,5,5),h.target=a,s.add(h);let m=new o.Mig(4210752,.6);s.add(m),s.add(a),e.push(a),console.log("Satellite: 卫星已添加到场景",JSON.stringify({satelliteId:t.id,modelName:a.name,position:a.position,visible:a.visible,sceneChildren:s.children.length,lightsAdded:!0}))},e=>{},i=>{console.error("卫星加载失败，使用备用几何体:",t.id,t.model,i),console.error("错误详情:",{message:(null==i?void 0:i.message)||"未知错误",type:(null==i?void 0:i.type)||"未知类型",url:t.model});let a=new o.DvJ(1.5,.8,3),u=new o.xoR({color:4473924,shininess:100}),d=new o.Kj0(a,u);d.position.set(n,l,c),d.name="satellite-".concat(t.id,"-fallback"),d.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r},s.add(d),e.push(d),console.log("Satellite: 备用几何体已添加到场景",{satelliteId:t.id,meshName:d.name,position:d.position,visible:d.visible,sceneChildren:s.children.length})})}catch(d){console.error("Satellite: GLTFLoader 创建失败",d);let i=new o.DvJ(1,.5,2),a=new o.xoR({color:4473924,shininess:100}),u=new o.Kj0(i,a);u.position.set(n,l,c),u.name="satellite-".concat(t.id,"-fallback"),u.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r},s.add(u),e.push(u)}}),u.current.meshes=e,u.current.satelliteIds=n,()=>{u.current.meshes.forEach(e=>{s.remove(e),e.traverse(e=>{e instanceof o.Kj0&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))})}),u.current.highlightMeshes.forEach(e=>{s.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}),u.current={meshes:[],satelliteIds:[],selectedIndex:null,highlightMeshes:new Map}}},[s,c,a,t,r]),null}},9363:function(e,t,r){"use strict";r.r(t),r.d(t,{SceneContext:function(){return c},SceneProvider:function(){return a}});var n=r(2676),o=r(5271),i=r(1521),l=r(8957),s=r(7577);let c=(0,o.createContext)({scene:null,camera:null,renderer:null,controls:null,isInitialized:!1,isRotating:!1,setIsRotating:()=>{},resourceManager:null,getEntityRegistry:()=>null,isLoaded:!1,setIsLoaded:()=>{}}),a=e=>{let{children:t,containerRef:r}=e,[a,u]=(0,o.useState)(!1),[d,h]=(0,o.useState)(!0),[m,g]=(0,o.useState)(!1),[p,f]=(0,o.useState)(null),v=(0,o.useRef)(null),S=(0,o.useRef)(null),w=(0,o.useRef)(null),y=(0,o.useRef)(null),P=(0,o.useRef)(null),b=(0,o.useRef)(new Map),x=(0,o.useRef)([]),E=(0,o.useRef)(1),M=(0,o.useRef)({entities:new Map,register(e){if(this.entities.has(e.id)){console.warn("SceneProvider: 实体ID冲突，已存在ID为 ".concat(e.id," 的实体，将被替换"));let t=this.entities.get(e.id);t&&t.object.parent&&(t.object.parent.remove(t.object),t.dispose())}this.entities.set(e.id,e),console.log("SceneProvider: 注册实体 [".concat(e.type,"] ID: ").concat(e.id))},get(e){return this.entities.get(e)},getByType(e){let t=[];return this.entities.forEach(r=>{r.type===e&&t.push(r)}),t},remove(e){let t=this.entities.get(e);t&&(t.object.parent&&t.object.parent.remove(t.object),t.dispose(),this.entities.delete(e),console.log("SceneProvider: 移除实体 ID: ".concat(e)))},has(e){return this.entities.has(e)},clear(){Array.from(this.entities.keys()).forEach(e=>this.remove(e)),console.log("SceneProvider: 清空所有实体")}}),C=(0,o.useRef)(null),R=(0,o.useCallback)(()=>{if(!r.current||!w.current||!S.current)return;let e=r.current.clientWidth,t=r.current.clientHeight,n=Math.max(e-380,1);S.current.aspect=n/t,S.current.updateProjectionMatrix(),w.current.setSize(e,t),w.current.setViewport(380,0,n,t)},[r]);(0,o.useEffect)(()=>{try{if(!r.current){console.log("SceneProvider: 容器元素不可用，等待DOM加载");return}let e=document.createElement("canvas");if(!(e.getContext("webgl")||e.getContext("experimental-webgl"))){let e="WebGL不受支持，无法初始化3D场景";console.error(e),f(e);return}let t=new i.xsS;t.background=new i.Ilk(0),v.current=t;let n=r.current.clientWidth,o=r.current.clientHeight,c=Math.max(n-380,1),a=new i.cPb(40,c/o,.1,2e3);S.current=a;let d=new l.CP7({antialias:!0,powerPreference:"high-performance",stencil:!1,depth:!0,alpha:!1});d.setSize(n,o),d.setPixelRatio(Math.min(window.devicePixelRatio,2)),d.setViewport(380,0,c,o),d.shadowMap.enabled=!0,d.shadowMap.type=i.ntZ,d.outputColorSpace=i.KI_,d.toneMapping=i.uL9,d.toneMappingExposure=1,d.info.autoReset=!1,r.current.appendChild(d.domElement),w.current=d,console.log("SceneProvider: 渲染器设置完成",{shadowMapEnabled:d.shadowMap.enabled,outputColorSpace:d.outputColorSpace,toneMapping:d.toneMapping,toneMappingExposure:d.toneMappingExposure,pixelRatio:d.getPixelRatio()});let h=new s.z(a,d.domElement);h.enableDamping=!0,h.dampingFactor=.05,h.minDistance=3,h.maxDistance=8,h.enablePan=!1,h.rotateSpeed=.5,h.zoomSpeed=.5,y.current=h;let m=new i.dpR;C.current={textureLoader:m,loadTexture:e=>new Promise((t,r)=>{let n=0,o=()=>{m.load(e,r=>{w.current&&(r.anisotropy=Math.min(4,w.current.capabilities.getMaxAnisotropy())),(e.includes("Albedo")||e.includes("night_lights"))&&(r.colorSpace=i.KI_),r.generateMipmaps=!0,r.minFilter=i.D1R,r.magFilter=i.wem,t(r)},t=>{console.log("SceneProvider: 纹理加载进度: ".concat(e," - ").concat(t.loaded,"/").concat(t.total))},t=>{console.error("SceneProvider: 纹理加载失败: ".concat(e),t),n<3?(n++,console.log("SceneProvider: 重试加载纹理 ".concat(e," (").concat(n,"/").concat(3,")")),setTimeout(o,1e3*n)):r(t)})};o()}),registerUpdateFunction:e=>{let t=E.current++;return b.current.set(t,e),console.log("SceneProvider: 已注册更新函数 ID: ".concat(t)),t},unregisterUpdateFunction:e=>{b.current.delete(e),console.log("SceneProvider: 已注销更新函数 ID: ".concat(e))},registerForCleanup:e=>{x.current.push(e),console.log("SceneProvider: 已注册清理函数")},entityRegistry:M.current},window.addEventListener("resize",R);let g=0,p=0,I=0,k=e=>{if(P.current=requestAnimationFrame(k),!(e-g<16.666666666666668)){if(g=e,p++,e-I>=1e3){let t=Math.round(1e3*p/(e-I));t<30&&console.warn("SceneProvider: 低帧率警告 - ".concat(t," FPS")),p=0,I=e}y.current&&y.current.update(),b.current.forEach(t=>{try{t(e)}catch(e){console.error("SceneProvider: 更新函数执行错误",e)}}),w.current&&v.current&&S.current&&w.current.render(v.current,S.current)}};k(0),u(!0),f(null),console.log("SceneProvider: Three.js环境初始化完成")}catch(t){let e=t instanceof Error?t.message:"初始化失败";console.error("SceneProvider: 初始化错误",t),f(e)}return()=>{if(console.log("SceneProvider: 开始清理Three.js资源"),window.removeEventListener("resize",R),P.current&&(cancelAnimationFrame(P.current),P.current=null,console.log("SceneProvider: 动画帧已取消")),C.current&&C.current.entityRegistry&&(console.log("SceneProvider: 清理所有注册的实体"),C.current.entityRegistry.clear()),console.log("SceneProvider: 执行 ".concat(x.current.length," 个注册的清理函数")),x.current.forEach(e=>{try{e()}catch(e){console.error("执行清理函数时出错:",e)}}),b.current.clear(),x.current=[],w.current){try{r.current&&r.current.contains(w.current.domElement)&&(r.current.removeChild(w.current.domElement),console.log("SceneProvider: 渲染器DOM元素已移除"))}catch(e){console.error("移除渲染器DOM元素时出错:",e)}w.current.dispose(),w.current.forceContextLoss(),w.current=null,console.log("SceneProvider: 渲染器已释放")}y.current&&(y.current.dispose(),y.current=null,console.log("SceneProvider: 控制器已释放")),v.current=null,S.current=null,C.current=null,console.log("SceneProvider: Three.js资源清理完成")}},[r]);let I=(0,o.useMemo)(()=>({scene:v.current,camera:S.current,renderer:w.current,controls:y.current,isInitialized:a,resourceManager:C.current,isRotating:d,setIsRotating:h,getEntityRegistry:()=>{var e;return(null===(e=C.current)||void 0===e?void 0:e.entityRegistry)||null},isLoaded:m,setIsLoaded:g}),[a,d,m]);return p?(0,n.jsx)("div",{className:"error-container",children:(0,n.jsxs)("div",{className:"error-message",children:[(0,n.jsx)("h3",{children:"初始化失败"}),(0,n.jsx)("p",{children:p}),(0,n.jsx)("button",{onClick:()=>window.location.reload(),children:"重新加载"})]})}):(0,n.jsx)(c.Provider,{value:I,children:t})};t.default=a}},function(e){e.O(0,[593,944,577,768,774,888,179],function(){return e(e.s=4882)}),_N_E=e.O()}]);
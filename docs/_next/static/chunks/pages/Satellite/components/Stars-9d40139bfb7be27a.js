(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[688],{6626:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Satellite/components/Stars",function(){return r(5340)}])},9363:function(e,t,r){"use strict";r.r(t),r.d(t,{SceneContext:function(){return s},SceneProvider:function(){return l}});var n=r(2676),o=r(5271),i=r(1521),c=r(8957),a=r(7577);let s=(0,o.createContext)({scene:null,camera:null,renderer:null,controls:null,isInitialized:!1,isRotating:!1,setIsRotating:()=>{},resourceManager:null,getEntityRegistry:()=>null,isLoaded:!1,setIsLoaded:()=>{}}),l=e=>{let{children:t,containerRef:r}=e,[l,u]=(0,o.useState)(!1),[d,p]=(0,o.useState)(!0),[g,h]=(0,o.useState)(!1),m=(0,o.useRef)(null),v=(0,o.useRef)(null),f=(0,o.useRef)(null),w=(0,o.useRef)(null),M=(0,o.useRef)(null),S=(0,o.useRef)(new Map),P=(0,o.useRef)([]),y=(0,o.useRef)(1),b=(0,o.useRef)({entities:new Map,register(e){if(this.entities.has(e.id)){console.warn("SceneProvider: 实体ID冲突，已存在ID为 ".concat(e.id," 的实体，将被替换"));let t=this.entities.get(e.id);t&&t.object.parent&&(t.object.parent.remove(t.object),t.dispose())}this.entities.set(e.id,e),console.log("SceneProvider: 注册实体 [".concat(e.type,"] ID: ").concat(e.id))},get(e){return this.entities.get(e)},getByType(e){let t=[];return this.entities.forEach(r=>{r.type===e&&t.push(r)}),t},remove(e){let t=this.entities.get(e);t&&(t.object.parent&&t.object.parent.remove(t.object),t.dispose(),this.entities.delete(e),console.log("SceneProvider: 移除实体 ID: ".concat(e)))},has(e){return this.entities.has(e)},clear(){Array.from(this.entities.keys()).forEach(e=>this.remove(e)),console.log("SceneProvider: 清空所有实体")}}),E=(0,o.useRef)(null);(0,o.useEffect)(()=>{if(!r.current){console.log("SceneProvider: 容器元素不可用，等待DOM加载");return}let e=new i.xsS;e.background=new i.Ilk(0),m.current=e;let t=r.current.clientWidth,n=r.current.clientHeight,o=t-380,s=new i.cPb(40,o/n,.1,2e3);v.current=s;let l=new c.CP7({antialias:!0});l.setSize(t,n),l.setPixelRatio(window.devicePixelRatio),l.setViewport(380,0,o,n),l.shadowMap.enabled=!0,l.shadowMap.type=i.ntZ,l.outputColorSpace=i.KI_,l.toneMapping=i.uL9,l.toneMappingExposure=1,r.current.appendChild(l.domElement),f.current=l,console.log("SceneProvider: 渲染器设置完成",{shadowMapEnabled:l.shadowMap.enabled,outputColorSpace:l.outputColorSpace,toneMapping:l.toneMapping,toneMappingExposure:l.toneMappingExposure});let d=new a.z(s,l.domElement);d.enableDamping=!0,d.dampingFactor=.05,d.minDistance=3,d.maxDistance=8,d.enablePan=!1,d.rotateSpeed=.5,d.zoomSpeed=.5,w.current=d;let p=new i.dpR;E.current={textureLoader:p,loadTexture:e=>new Promise((t,r)=>{p.load(e,r=>{f.current&&(r.anisotropy=Math.min(4,f.current.capabilities.getMaxAnisotropy())),(e.includes("Albedo")||e.includes("night_lights"))&&(r.colorSpace=i.KI_),r.generateMipmaps=!0,r.minFilter=i.D1R,r.magFilter=i.wem,t(r)},t=>{console.log("SceneProvider: 纹理加载进度: ".concat(e," - ").concat(t.loaded,"/").concat(t.total))},t=>{console.error("SceneProvider: 纹理加载失败: ".concat(e),t),r(t)})}),registerUpdateFunction:e=>{let t=y.current++;return S.current.set(t,e),console.log("SceneProvider: 已注册更新函数 ID: ".concat(t)),t},unregisterUpdateFunction:e=>{S.current.delete(e),console.log("SceneProvider: 已注销更新函数 ID: ".concat(e))},registerForCleanup:e=>{P.current.push(e),console.log("SceneProvider: 已注册清理函数")},entityRegistry:b.current};let g=()=>{if(!r.current||!f.current||!v.current)return;let e=r.current.clientWidth,t=r.current.clientHeight,n=Math.max(e-380,1);v.current.aspect=n/t,v.current.updateProjectionMatrix(),f.current.setSize(e,t),f.current.setViewport(380,0,n,t)};window.addEventListener("resize",g);let h=0,R=e=>{M.current=requestAnimationFrame(R),!(e-h<16.666666666666668)&&(h=e,w.current&&w.current.update(),S.current.forEach(t=>{t(e)}),f.current&&m.current&&v.current&&f.current.render(m.current,v.current))};return R(0),u(!0),console.log("SceneProvider: Three.js环境初始化完成"),()=>{if(console.log("SceneProvider: 开始清理Three.js资源"),window.removeEventListener("resize",g),M.current&&(cancelAnimationFrame(M.current),M.current=null,console.log("SceneProvider: 动画帧已取消")),E.current&&E.current.entityRegistry&&(console.log("SceneProvider: 清理所有注册的实体"),E.current.entityRegistry.clear()),console.log("SceneProvider: 执行 ".concat(P.current.length," 个注册的清理函数")),P.current.forEach(e=>{try{e()}catch(e){console.error("执行清理函数时出错:",e)}}),S.current.clear(),P.current=[],f.current){try{r.current&&r.current.contains(f.current.domElement)&&(r.current.removeChild(f.current.domElement),console.log("SceneProvider: 渲染器DOM元素已移除"))}catch(e){console.error("移除渲染器DOM元素时出错:",e)}f.current.dispose(),f.current.forceContextLoss(),f.current=null,console.log("SceneProvider: 渲染器已释放")}w.current&&(w.current.dispose(),w.current=null,console.log("SceneProvider: 控制器已释放")),m.current=null,v.current=null,E.current=null,console.log("SceneProvider: Three.js资源清理完成")}},[r]);let R=(0,o.useMemo)(()=>({scene:m.current,camera:v.current,renderer:f.current,controls:w.current,isInitialized:l,resourceManager:E.current,isRotating:d,setIsRotating:p,getEntityRegistry:()=>{var e;return(null===(e=E.current)||void 0===e?void 0:e.entityRegistry)||null},isLoaded:g,setIsLoaded:h}),[l,d,g]);return(0,n.jsx)(s.Provider,{value:R,children:t})};t.default=l},5340:function(e,t,r){"use strict";r.r(t);var n=r(5271),o=r(1521),i=r(9363);t.default=()=>{let{scene:e,isInitialized:t}=(0,n.useContext)(i.SceneContext),r=(0,n.useRef)({stars:null,animationId:null});return(0,n.useEffect)(()=>{if(!e||!t)return;let n=()=>{if(r.current.stars){let e=.001*Date.now(),t=r.current.stars.geometry.attributes.position.array;for(let r=0;r<t.length;r+=3){let n=.1*Math.sin(2*e+.1*r)+.9;t[r+1]+=.001*Math.sin(e+r)*n}r.current.stars.geometry.attributes.position.needsUpdate=!0}r.current.animationId=requestAnimationFrame(n)};return(()=>{let t=new o.u9r,n=new Float32Array(6e3),i=new Float32Array(6e3),c=new Float32Array(2e3);for(let e=0;e<2e3;e++){let t=3*e,r=50+50*Math.random(),a=Math.random()*Math.PI*2,s=Math.acos(2*Math.random()-1);n[t]=r*Math.sin(s)*Math.cos(a),n[t+1]=r*Math.sin(s)*Math.sin(a),n[t+2]=r*Math.cos(s);let l=new o.Ilk;l.setHSL(.6+.1*Math.random(),.8,.8+.2*Math.random()),i[t]=l.r,i[t+1]=l.g,i[t+2]=l.b,c[e]=2*Math.random()+.5}t.setAttribute("position",new o.TlE(n,3)),t.setAttribute("color",new o.TlE(i,3)),t.setAttribute("size",new o.TlE(c,1));let a=new o.jyz({vertexShader:"\n                    attribute float size;\n                    attribute vec3 color;\n                    varying vec3 vColor;\n                    void main() {\n                        vColor = color;\n                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n                        gl_PointSize = size * (300.0 / -mvPosition.z);\n                        gl_Position = projectionMatrix * mvPosition;\n                    }\n                ",fragmentShader:"\n                    varying vec3 vColor;\n                    void main() {\n                        float distance = length(gl_PointCoord - vec2(0.5));\n                        if (distance > 0.5) discard;\n                        gl_FragColor = vec4(vColor, 1.0 - distance * 2.0);\n                    }\n                ",transparent:!0,depthWrite:!1,blending:o.WMw}),s=new o.woe(t,a);e.add(s),r.current.stars=s})(),n(),()=>{r.current.animationId&&cancelAnimationFrame(r.current.animationId),r.current.stars&&(e.remove(r.current.stars),r.current.stars.geometry.dispose(),r.current.stars.material.dispose())}},[e,t]),null}}},function(e){e.O(0,[593,944,577,774,888,179],function(){return e(e.s=6626)}),_N_E=e.O()}]);
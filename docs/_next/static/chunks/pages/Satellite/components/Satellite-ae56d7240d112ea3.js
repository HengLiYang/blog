(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[105],{4882:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Satellite/components/Satellite",function(){return r(5814)}])},5814:function(e,t,r){"use strict";r.r(t);var n=r(5271),i=r(1521),o=r(9768),l=r(9363);t.default=e=>{let{satellites:t,onSatelliteClick:r}=e,{scene:s,resourceManager:a,isInitialized:c}=(0,n.useContext)(l.SceneContext),u=(0,n.useRef)({meshes:[],satelliteIds:[],selectedIndex:null,highlightMeshes:new Map});return(0,n.useEffect)(()=>{if(!s||!a||!c||0===t.length){console.log("Satellite: 条件不满足，跳过加载",{scene:!!s,resourceManager:!!a,isInitialized:c,satellitesLength:t.length});return}console.log("Satellite: 开始加载卫星模型",{satellitesCount:t.length,satellites:t.map(e=>({id:e.id,name:e.name,position:e.position,model:e.model}))}),u.current.meshes.length>0&&(u.current.meshes.forEach(e=>{s.remove(e),e.traverse(e=>{e instanceof i.Kj0&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))})}),u.current.highlightMeshes.forEach(e=>{s.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}));let e=[],n=t.map(e=>e.id);return t.forEach(t=>{let[n,l,a]=t.position;try{console.log("Satellite: 开始加载模型",t.model),new o.E().load(t.model,o=>{console.log("卫星加载成功:",t.id,t.model,{scene:o.scene,animations:o.animations,asset:o.asset,sceneChildren:o.scene.children.length});let c=o.scene;c.position.set(n,l,a);let u=1;switch(t.id){case"satellite-1":case"satellite-3":u=3;break;case"satellite-2":u=1;break;case"satellite-4":u=2.5;break;case"satellite-5":u=3.5;break;default:u=2}c.scale.set(u,u,u),c.name="satellite-".concat(t.id);let d=new i.ZzF().setFromObject(c);console.log("Satellite: 模型包围盒信息",JSON.stringify({satelliteId:t.id,scale:u,min:d.min,max:d.max,size:d.getSize(new i.Pa4),center:d.getCenter(new i.Pa4)})),c.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r},c.traverse(e=>{e instanceof i.Kj0&&(e.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r})});let p=new i.Ox3(16777215,1);p.position.set(5,5,5),p.target=c,s.add(p);let h=new i.Mig(4210752,.6);s.add(h),s.add(c),e.push(c),console.log("Satellite: 卫星已添加到场景",JSON.stringify({satelliteId:t.id,modelName:c.name,position:c.position,visible:c.visible,sceneChildren:s.children.length,lightsAdded:!0}))},e=>{},o=>{console.error("卫星加载失败，使用备用几何体:",t.id,t.model,o),console.error("错误详情:",{message:(null==o?void 0:o.message)||"未知错误",type:(null==o?void 0:o.type)||"未知类型",url:t.model});let c=new i.DvJ(1.5,.8,3),u=new i.xoR({color:4473924,shininess:100}),d=new i.Kj0(c,u);d.position.set(n,l,a),d.name="satellite-".concat(t.id,"-fallback"),d.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r},s.add(d),e.push(d),console.log("Satellite: 备用几何体已添加到场景",{satelliteId:t.id,meshName:d.name,position:d.position,visible:d.visible,sceneChildren:s.children.length})})}catch(d){console.error("Satellite: GLTFLoader 创建失败",d);let o=new i.DvJ(1,.5,2),c=new i.xoR({color:4473924,shininess:100}),u=new i.Kj0(o,c);u.position.set(n,l,a),u.name="satellite-".concat(t.id,"-fallback"),u.userData={isClickable:!0,satelliteId:t.id,onSatelliteClick:r},s.add(u),e.push(u)}}),u.current.meshes=e,u.current.satelliteIds=n,()=>{u.current.meshes.forEach(e=>{s.remove(e),e.traverse(e=>{e instanceof i.Kj0&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))})}),u.current.highlightMeshes.forEach(e=>{s.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}),u.current={meshes:[],satelliteIds:[],selectedIndex:null,highlightMeshes:new Map}}},[s,a,c,t,r]),null}},9363:function(e,t,r){"use strict";r.r(t),r.d(t,{SceneContext:function(){return a},SceneProvider:function(){return c}});var n=r(2676),i=r(5271),o=r(1521),l=r(8957),s=r(7577);let a=(0,i.createContext)({scene:null,camera:null,renderer:null,controls:null,isInitialized:!1,isRotating:!1,setIsRotating:()=>{},resourceManager:null,getEntityRegistry:()=>null,isLoaded:!1,setIsLoaded:()=>{}}),c=e=>{let{children:t,containerRef:r}=e,[c,u]=(0,i.useState)(!1),[d,p]=(0,i.useState)(!0),[h,m]=(0,i.useState)(!1),g=(0,i.useRef)(null),f=(0,i.useRef)(null),v=(0,i.useRef)(null),S=(0,i.useRef)(null),w=(0,i.useRef)(null),y=(0,i.useRef)(new Map),E=(0,i.useRef)([]),P=(0,i.useRef)(1),b=(0,i.useRef)({entities:new Map,register(e){if(this.entities.has(e.id)){console.warn("SceneProvider: 实体ID冲突，已存在ID为 ".concat(e.id," 的实体，将被替换"));let t=this.entities.get(e.id);t&&t.object.parent&&(t.object.parent.remove(t.object),t.dispose())}this.entities.set(e.id,e),console.log("SceneProvider: 注册实体 [".concat(e.type,"] ID: ").concat(e.id))},get(e){return this.entities.get(e)},getByType(e){let t=[];return this.entities.forEach(r=>{r.type===e&&t.push(r)}),t},remove(e){let t=this.entities.get(e);t&&(t.object.parent&&t.object.parent.remove(t.object),t.dispose(),this.entities.delete(e),console.log("SceneProvider: 移除实体 ID: ".concat(e)))},has(e){return this.entities.has(e)},clear(){Array.from(this.entities.keys()).forEach(e=>this.remove(e)),console.log("SceneProvider: 清空所有实体")}}),M=(0,i.useRef)(null);(0,i.useEffect)(()=>{if(!r.current){console.log("SceneProvider: 容器元素不可用，等待DOM加载");return}let e=new o.xsS;e.background=new o.Ilk(0),g.current=e;let t=r.current.clientWidth,n=r.current.clientHeight,i=t-380,a=new o.cPb(40,i/n,.1,2e3);f.current=a;let c=new l.CP7({antialias:!0});c.setSize(t,n),c.setPixelRatio(window.devicePixelRatio),c.setViewport(380,0,i,n),c.shadowMap.enabled=!0,c.shadowMap.type=o.ntZ,c.outputColorSpace=o.KI_,c.toneMapping=o.uL9,c.toneMappingExposure=1,r.current.appendChild(c.domElement),v.current=c,console.log("SceneProvider: 渲染器设置完成",{shadowMapEnabled:c.shadowMap.enabled,outputColorSpace:c.outputColorSpace,toneMapping:c.toneMapping,toneMappingExposure:c.toneMappingExposure});let d=new s.z(a,c.domElement);d.enableDamping=!0,d.dampingFactor=.05,d.minDistance=3,d.maxDistance=8,d.enablePan=!1,d.rotateSpeed=.5,d.zoomSpeed=.5,S.current=d;let p=new o.dpR;M.current={textureLoader:p,loadTexture:e=>new Promise((t,r)=>{p.load(e,r=>{v.current&&(r.anisotropy=Math.min(4,v.current.capabilities.getMaxAnisotropy())),(e.includes("Albedo")||e.includes("night_lights"))&&(r.colorSpace=o.KI_),r.generateMipmaps=!0,r.minFilter=o.D1R,r.magFilter=o.wem,t(r)},t=>{console.log("SceneProvider: 纹理加载进度: ".concat(e," - ").concat(t.loaded,"/").concat(t.total))},t=>{console.error("SceneProvider: 纹理加载失败: ".concat(e),t),r(t)})}),registerUpdateFunction:e=>{let t=P.current++;return y.current.set(t,e),console.log("SceneProvider: 已注册更新函数 ID: ".concat(t)),t},unregisterUpdateFunction:e=>{y.current.delete(e),console.log("SceneProvider: 已注销更新函数 ID: ".concat(e))},registerForCleanup:e=>{E.current.push(e),console.log("SceneProvider: 已注册清理函数")},entityRegistry:b.current};let h=()=>{if(!r.current||!v.current||!f.current)return;let e=r.current.clientWidth,t=r.current.clientHeight,n=Math.max(e-380,1);f.current.aspect=n/t,f.current.updateProjectionMatrix(),v.current.setSize(e,t),v.current.setViewport(380,0,n,t)};window.addEventListener("resize",h);let m=0,C=e=>{w.current=requestAnimationFrame(C),!(e-m<16.666666666666668)&&(m=e,S.current&&S.current.update(),y.current.forEach(t=>{t(e)}),v.current&&g.current&&f.current&&v.current.render(g.current,f.current))};return C(0),u(!0),console.log("SceneProvider: Three.js环境初始化完成"),()=>{if(console.log("SceneProvider: 开始清理Three.js资源"),window.removeEventListener("resize",h),w.current&&(cancelAnimationFrame(w.current),w.current=null,console.log("SceneProvider: 动画帧已取消")),M.current&&M.current.entityRegistry&&(console.log("SceneProvider: 清理所有注册的实体"),M.current.entityRegistry.clear()),console.log("SceneProvider: 执行 ".concat(E.current.length," 个注册的清理函数")),E.current.forEach(e=>{try{e()}catch(e){console.error("执行清理函数时出错:",e)}}),y.current.clear(),E.current=[],v.current){try{r.current&&r.current.contains(v.current.domElement)&&(r.current.removeChild(v.current.domElement),console.log("SceneProvider: 渲染器DOM元素已移除"))}catch(e){console.error("移除渲染器DOM元素时出错:",e)}v.current.dispose(),v.current.forceContextLoss(),v.current=null,console.log("SceneProvider: 渲染器已释放")}S.current&&(S.current.dispose(),S.current=null,console.log("SceneProvider: 控制器已释放")),g.current=null,f.current=null,M.current=null,console.log("SceneProvider: Three.js资源清理完成")}},[r]);let C=(0,i.useMemo)(()=>({scene:g.current,camera:f.current,renderer:v.current,controls:S.current,isInitialized:c,resourceManager:M.current,isRotating:d,setIsRotating:p,getEntityRegistry:()=>{var e;return(null===(e=M.current)||void 0===e?void 0:e.entityRegistry)||null},isLoaded:h,setIsLoaded:m}),[c,d,h]);return(0,n.jsx)(a.Provider,{value:C,children:t})};t.default=c}},function(e){e.O(0,[593,944,577,768,774,888,179],function(){return e(e.s=4882)}),_N_E=e.O()}]);
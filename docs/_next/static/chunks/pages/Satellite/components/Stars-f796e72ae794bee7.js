(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[688],{6626:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Satellite/components/Stars",function(){return r(5340)}])},9363:function(e,t,r){"use strict";r.r(t),r.d(t,{SceneContext:function(){return s},SceneProvider:function(){return l}});var n=r(2676),o=r(5271),c=r(1521),i=r(8957),a=r(7577);let s=(0,o.createContext)({scene:null,camera:null,renderer:null,controls:null,isInitialized:!1,isRotating:!1,setIsRotating:()=>{},resourceManager:null,getEntityRegistry:()=>null,isLoaded:!1,setIsLoaded:()=>{}}),l=e=>{let{children:t,containerRef:r}=e,[l,u]=(0,o.useState)(!1),[d,p]=(0,o.useState)(!0),[g,h]=(0,o.useState)(!1),[m,v]=(0,o.useState)(null),f=(0,o.useRef)(null),w=(0,o.useRef)(null),S=(0,o.useRef)(null),P=(0,o.useRef)(null),M=(0,o.useRef)(null),y=(0,o.useRef)(new Map),b=(0,o.useRef)([]),x=(0,o.useRef)(1),E=(0,o.useRef)({entities:new Map,register(e){if(this.entities.has(e.id)){console.warn("SceneProvider: 实体ID冲突，已存在ID为 ".concat(e.id," 的实体，将被替换"));let t=this.entities.get(e.id);t&&t.object.parent&&(t.object.parent.remove(t.object),t.dispose())}this.entities.set(e.id,e),console.log("SceneProvider: 注册实体 [".concat(e.type,"] ID: ").concat(e.id))},get(e){return this.entities.get(e)},getByType(e){let t=[];return this.entities.forEach(r=>{r.type===e&&t.push(r)}),t},remove(e){let t=this.entities.get(e);t&&(t.object.parent&&t.object.parent.remove(t.object),t.dispose(),this.entities.delete(e),console.log("SceneProvider: 移除实体 ID: ".concat(e)))},has(e){return this.entities.has(e)},clear(){Array.from(this.entities.keys()).forEach(e=>this.remove(e)),console.log("SceneProvider: 清空所有实体")}}),R=(0,o.useRef)(null),C=(0,o.useCallback)(()=>{if(!r.current||!S.current||!w.current)return;let e=r.current.clientWidth,t=r.current.clientHeight,n=Math.max(e-380,1);w.current.aspect=n/t,w.current.updateProjectionMatrix(),S.current.setSize(e,t),S.current.setViewport(380,0,n,t)},[r]);(0,o.useEffect)(()=>{try{if(!r.current){console.log("SceneProvider: 容器元素不可用，等待DOM加载");return}let e=document.createElement("canvas");if(!(e.getContext("webgl")||e.getContext("experimental-webgl"))){let e="WebGL不受支持，无法初始化3D场景";console.error(e),v(e);return}let t=new c.xsS;t.background=new c.Ilk(0),f.current=t;let n=r.current.clientWidth,o=r.current.clientHeight,s=Math.max(n-380,1),l=new c.cPb(40,s/o,.1,2e3);w.current=l;let d=new i.CP7({antialias:!0,powerPreference:"high-performance",stencil:!1,depth:!0,alpha:!1});d.setSize(n,o),d.setPixelRatio(Math.min(window.devicePixelRatio,2)),d.setViewport(380,0,s,o),d.shadowMap.enabled=!0,d.shadowMap.type=c.ntZ,d.outputColorSpace=c.KI_,d.toneMapping=c.uL9,d.toneMappingExposure=1,d.info.autoReset=!1,r.current.appendChild(d.domElement),S.current=d,console.log("SceneProvider: 渲染器设置完成",{shadowMapEnabled:d.shadowMap.enabled,outputColorSpace:d.outputColorSpace,toneMapping:d.toneMapping,toneMappingExposure:d.toneMappingExposure,pixelRatio:d.getPixelRatio()});let p=new a.z(l,d.domElement);p.enableDamping=!0,p.dampingFactor=.05,p.minDistance=3,p.maxDistance=8,p.enablePan=!1,p.rotateSpeed=.5,p.zoomSpeed=.5,P.current=p;let g=new c.dpR;R.current={textureLoader:g,loadTexture:e=>new Promise((t,r)=>{let n=0,o=()=>{g.load(e,r=>{S.current&&(r.anisotropy=Math.min(4,S.current.capabilities.getMaxAnisotropy())),(e.includes("Albedo")||e.includes("night_lights"))&&(r.colorSpace=c.KI_),r.generateMipmaps=!0,r.minFilter=c.D1R,r.magFilter=c.wem,t(r)},t=>{console.log("SceneProvider: 纹理加载进度: ".concat(e," - ").concat(t.loaded,"/").concat(t.total))},t=>{console.error("SceneProvider: 纹理加载失败: ".concat(e),t),n<3?(n++,console.log("SceneProvider: 重试加载纹理 ".concat(e," (").concat(n,"/").concat(3,")")),setTimeout(o,1e3*n)):r(t)})};o()}),registerUpdateFunction:e=>{let t=x.current++;return y.current.set(t,e),console.log("SceneProvider: 已注册更新函数 ID: ".concat(t)),t},unregisterUpdateFunction:e=>{y.current.delete(e),console.log("SceneProvider: 已注销更新函数 ID: ".concat(e))},registerForCleanup:e=>{b.current.push(e),console.log("SceneProvider: 已注册清理函数")},entityRegistry:E.current},window.addEventListener("resize",C);let h=0,m=0,_=0,j=e=>{if(M.current=requestAnimationFrame(j),!(e-h<16.666666666666668)){if(h=e,m++,e-_>=1e3){let t=Math.round(1e3*m/(e-_));t<30&&console.warn("SceneProvider: 低帧率警告 - ".concat(t," FPS")),m=0,_=e}P.current&&P.current.update(),y.current.forEach(t=>{try{t(e)}catch(e){console.error("SceneProvider: 更新函数执行错误",e)}}),S.current&&f.current&&w.current&&S.current.render(f.current,w.current)}};j(0),u(!0),v(null),console.log("SceneProvider: Three.js环境初始化完成")}catch(t){let e=t instanceof Error?t.message:"初始化失败";console.error("SceneProvider: 初始化错误",t),v(e)}return()=>{if(console.log("SceneProvider: 开始清理Three.js资源"),window.removeEventListener("resize",C),M.current&&(cancelAnimationFrame(M.current),M.current=null,console.log("SceneProvider: 动画帧已取消")),R.current&&R.current.entityRegistry&&(console.log("SceneProvider: 清理所有注册的实体"),R.current.entityRegistry.clear()),console.log("SceneProvider: 执行 ".concat(b.current.length," 个注册的清理函数")),b.current.forEach(e=>{try{e()}catch(e){console.error("执行清理函数时出错:",e)}}),y.current.clear(),b.current=[],S.current){try{r.current&&r.current.contains(S.current.domElement)&&(r.current.removeChild(S.current.domElement),console.log("SceneProvider: 渲染器DOM元素已移除"))}catch(e){console.error("移除渲染器DOM元素时出错:",e)}S.current.dispose(),S.current.forceContextLoss(),S.current=null,console.log("SceneProvider: 渲染器已释放")}P.current&&(P.current.dispose(),P.current=null,console.log("SceneProvider: 控制器已释放")),f.current=null,w.current=null,R.current=null,console.log("SceneProvider: Three.js资源清理完成")}},[r]);let _=(0,o.useMemo)(()=>({scene:f.current,camera:w.current,renderer:S.current,controls:P.current,isInitialized:l,resourceManager:R.current,isRotating:d,setIsRotating:p,getEntityRegistry:()=>{var e;return(null===(e=R.current)||void 0===e?void 0:e.entityRegistry)||null},isLoaded:g,setIsLoaded:h}),[l,d,g]);return m?(0,n.jsx)("div",{className:"error-container",children:(0,n.jsxs)("div",{className:"error-message",children:[(0,n.jsx)("h3",{children:"初始化失败"}),(0,n.jsx)("p",{children:m}),(0,n.jsx)("button",{onClick:()=>window.location.reload(),children:"重新加载"})]})}):(0,n.jsx)(s.Provider,{value:_,children:t})};t.default=l},5340:function(e,t,r){"use strict";r.r(t);var n=r(5271),o=r(1521),c=r(9363);t.default=()=>{let{scene:e,isInitialized:t}=(0,n.useContext)(c.SceneContext),r=(0,n.useRef)({stars:null,animationId:null});return(0,n.useEffect)(()=>{if(!e||!t)return;let n=()=>{if(r.current.stars){let e=.001*Date.now(),t=r.current.stars.geometry.attributes.position.array;for(let r=0;r<t.length;r+=3){let n=.1*Math.sin(2*e+.1*r)+.9;t[r+1]+=.001*Math.sin(e+r)*n}r.current.stars.geometry.attributes.position.needsUpdate=!0}r.current.animationId=requestAnimationFrame(n)};return(()=>{let t=new o.u9r,n=new Float32Array(6e3),c=new Float32Array(6e3),i=new Float32Array(2e3);for(let e=0;e<2e3;e++){let t=3*e,r=50+50*Math.random(),a=Math.random()*Math.PI*2,s=Math.acos(2*Math.random()-1);n[t]=r*Math.sin(s)*Math.cos(a),n[t+1]=r*Math.sin(s)*Math.sin(a),n[t+2]=r*Math.cos(s);let l=new o.Ilk;l.setHSL(.6+.1*Math.random(),.8,.8+.2*Math.random()),c[t]=l.r,c[t+1]=l.g,c[t+2]=l.b,i[e]=2*Math.random()+.5}t.setAttribute("position",new o.TlE(n,3)),t.setAttribute("color",new o.TlE(c,3)),t.setAttribute("size",new o.TlE(i,1));let a=new o.jyz({vertexShader:"\n                    attribute float size;\n                    attribute vec3 color;\n                    varying vec3 vColor;\n                    void main() {\n                        vColor = color;\n                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n                        gl_PointSize = size * (300.0 / -mvPosition.z);\n                        gl_Position = projectionMatrix * mvPosition;\n                    }\n                ",fragmentShader:"\n                    varying vec3 vColor;\n                    void main() {\n                        float distance = length(gl_PointCoord - vec2(0.5));\n                        if (distance > 0.5) discard;\n                        gl_FragColor = vec4(vColor, 1.0 - distance * 2.0);\n                    }\n                ",transparent:!0,depthWrite:!1,blending:o.WMw}),s=new o.woe(t,a);e.add(s),r.current.stars=s})(),n(),()=>{r.current.animationId&&cancelAnimationFrame(r.current.animationId),r.current.stars&&(e.remove(r.current.stars),r.current.stars.geometry.dispose(),r.current.stars.material.dispose())}},[e,t]),null}}},function(e){e.O(0,[593,944,577,774,888,179],function(){return e(e.s=6626)}),_N_E=e.O()}]);